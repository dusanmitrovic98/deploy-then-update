<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Central Management Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@vscode/codicons/dist/codicon.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2d8cff;
      --primary-dark: #1a6fd0;
      --sidebar-bg: #20232a;
      --header-bg: #252b33;
      --content-bg: #1e2227;
      --card-bg: #252b33;
      --card-border: #2c3440;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --info: #58a6ff;
      --terminal-bg: #0d1117;
      --terminal-border: #30363d;
    }

    body {
      background: var(--content-bg);
      color: var(--text-primary);
      font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Layout */
    .app-container {
      display: flex;
      flex: 1 1 auto;
      min-height: 0;
      height: calc(100vh - 28px); /* Subtract status bar height */
      overflow: hidden;
    }

    #main-app {
      display: box;
      height: calc(100vh - 28px); /* Subtract status bar height */
      min-height: 0;
      flex: 1 1 auto;
      flex-direction: column;
    }

    .main-content {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .content {
      flex: 1 1 auto;
      overflow: auto;
      padding: 24px;
      position: relative;
      min-height: 0;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      display: flex;
      flex-direction: column;
      padding: 16px 0;
      border-right: 1px solid rgba(0, 0, 0, 0.2);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
      overflow-y: auto;
    }

    .brand {
      padding: 0 24px 16px;
      border-bottom: 1px solid #2d333b;
      margin-bottom: 16px;
    }

    .brand h2 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand h2 i {
      color: var(--primary);
      font-size: 22px;
    }

    .nav-section {
      padding: 0 16px;
      margin-bottom: 24px;
    }

    .nav-section h3 {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 1px;
      margin: 0 0 12px 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      border-radius: 6px;
      margin-bottom: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-primary);
      text-decoration: none;
    }

    .nav-item:hover {
      background: rgba(88, 166, 255, 0.1);
    }

    .nav-item.active {
      background: rgba(88, 166, 255, 0.2);
      color: var(--primary);
      font-weight: 500;
    }

    .nav-item i {
      margin-right: 12px;
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    /* Header */
    .header {
      height: 64px;
      background: var(--header-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      border-bottom: 1px solid #2d333b;
      z-index: 90;
    }

    .header-title {
      font-size: 18px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .user-menu:hover {
      background: rgba(88, 166, 255, 0.1);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
    }

    .user-role {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Cards */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .card-header {
      padding: 16px;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(88, 166, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 18px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .card-body {
      padding: 16px;
    }

    .card-footer {
      padding: 16px;
      display: flex;
      justify-content: flex-end;
      border-top: 1px solid var(--card-border);
    }

    /* Buttons */
    .btn {
      border-radius: 6px;
      padding: 8px 16px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
    }

    .btn-primary {
      background: var(--primary);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-warning {
      background: var(--warning);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #444c56;
      color: var(--text-primary);
    }

    .btn-outline:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Status badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.success {
      background: rgba(63, 185, 80, 0.15);
      color: var(--success);
    }

    .status-badge.warning {
      background: rgba(210, 153, 34, 0.15);
      color: var(--warning);
    }

    .status-badge.danger {
      background: rgba(248, 81, 73, 0.15);
      color: var(--danger);
    }

    /* Terminal */
    .terminal-container {
      background: var(--terminal-bg);
      border: 1px solid var(--terminal-border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .terminal-header {
      padding: 12px 16px;
      background: rgba(13, 17, 23, 0.8);
      border-bottom: 1px solid var(--terminal-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .terminal {
      height: 300px;
      overflow: auto;
      padding: 16px;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .terminal-line {
      margin-bottom: 4px;
    }

    .terminal-input-container {
      display: flex;
      gap: 12px;
    }

    .terminal-input {
      flex: 1;
      background: #0d1117;
      color: var(--text-primary);
      border: 1px solid var(--terminal-border);
      border-radius: 6px;
      padding: 10px 14px;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 14px;
    }

    /* File Explorer */
    .explorer-container {
      display: flex;
      height: 100%;
      min-height: 0;
      background: var(--content-bg);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--card-border);
    }

    .explorer-sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--card-border);
      overflow-y: auto;
      padding: 16px 0;
    }

    .explorer-content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .file-tree {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .file-tree li {
      padding: 0;
    }

    .folder,
    .file {
      padding: 8px 16px 8px 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
      position: relative;
    }

    .folder::before,
    .file::before {
      position: absolute;
      left: 16px;
    }

    .folder:hover,
    .file:hover {
      background: rgba(88, 166, 255, 0.1);
    }

    .folder {
      font-weight: 500;
    }

    .folder i {
      color: #e3b341;
    }

    .file i {
      color: #58a6ff;
    }

    .folder-children {
      list-style: none;
      padding: 0 0 0 24px;
      margin: 0;
      display: none;
    }

    .folder.open+.folder-children {
      display: block;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--card-border);
    }

    .editor-title {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    textarea.form-control {
      background: var(--terminal-bg);
      color: var(--text-primary);
      border: 1px solid var(--terminal-border);
      border-radius: 8px;
      padding: 16px;
      font-family: 'Fira Code', 'Consolas', monospace;
      min-height: 400px;
      width: 100%;
      resize: vertical;
    }

    /* Status Bar */
    .status-bar {
      height: 28px;
      background: var(--sidebar-bg);
      border-top: 1px solid #2d333b;
      display: flex;
      align-items: center;
      padding: 0 16px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 9999;
      min-width: 280px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast-icon {
      font-size: 20px;
    }

    .toast-success .toast-icon {
      color: var(--success);
    }

    .toast-error .toast-icon {
      color: var(--danger);
    }

    .toast-warning .toast-icon {
      color: var(--warning);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin: 0 0 4px 0;
    }

    .toast-message {
      margin: 0;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
    }

    /* Auth */
    .auth-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
    }

    .auth-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.3);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-icon {
      font-size: 48px;
      color: var(--primary);
      margin-bottom: 16px;
    }

    .auth-title {
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 8px 0;
    }

    .auth-subtitle {
      color: var(--text-secondary);
      margin: 0;
    }

    .auth-form .form-control {
      background: var(--terminal-bg);
      border: 1px solid var(--terminal-border);
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .auth-form .btn {
      width: 100%;
      padding: 12px;
    }

    .auth-footer {
      text-align: center;
      margin-top: 24px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 992px) {
      .sidebar {
        width: 72px;
      }

      .nav-item span {
        display: none;
      }

      .brand h2 span {
        display: none;
      }

      .brand {
        padding: 16px 0;
        text-align: center;
      }

      .brand h2 i {
        margin: 0 auto;
      }
    }

    @media (max-width: 768px) {
      .card-grid {
        grid-template-columns: 1fr;
      }

      .header {
        padding: 0 16px;
      }

      .user-info {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- Auth Section -->
  <div id="auth-section" class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-icon">
          <i class="codicon codicon-shield"></i>
        </div>
        <h2 class="auth-title">Central Management</h2>
        <p class="auth-subtitle">Enter your security key to continue</p>
      </div>
      <form class="auth-form" onsubmit="login(); return false;">
        <div class="mb-3">
          <input type="password" id="secretKey" class="form-control" placeholder="Enter Security Key"
            autocomplete="off">
        </div>
        <button class="btn btn-primary" type="submit">
          <i class="codicon codicon-unlock"></i> Authenticate
        </button>
        <div id="auth-error" class="text-danger mt-3 text-center" style="display: none;">
          <i class="codicon codicon-error"></i> Invalid security key. Please try again.
        </div>
        <div class="auth-footer">
          <p>Contact your administrator if you've lost your key</p>
        </div>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="main-app" style="display: none; height: 100%;">
    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="brand">
          <h2>
            <i class="codicon codicon-rocket"></i>
            <span>Central Management</span>
          </h2>
        </div>

        <div class="nav-section">
          <h3>Navigation</h3>
          <div class="nav-item active" onclick="switchTab('dashboard')">
            <i class="codicon codicon-dashboard"></i>
            <span>Dashboard</span>
          </div>
          <div class="nav-item" onclick="switchTab('files')">
            <i class="codicon codicon-files"></i>
            <span>Explorer</span>
          </div>
          <div class="nav-item" onclick="switchTab('terminal')">
            <i class="codicon codicon-terminal"></i>
            <span>Terminal</span>
          </div>
          <div class="nav-item" onclick="switchTab('config')">
            <i class="codicon codicon-settings-gear"></i>
            <span>Configuration</span>
          </div>
        </div>

        <div class="nav-section">
          <h3>System</h3>
          <div class="nav-item" onclick="apiAction('run')">
            <i class="codicon codicon-play"></i>
            <span>Start Services</span>
          </div>
          <div class="nav-item" onclick="apiAction('stop')">
            <i class="codicon codicon-debug-stop"></i>
            <span>Stop Services</span>
          </div>
          <div class="nav-item" onclick="apiAction('restart')">
            <i class="codicon codicon-refresh"></i>
            <span>Restart System</span>
          </div>
          <div class="nav-item" onclick="apiAction('update')">
            <i class="codicon codicon-cloud-download"></i>
            <span>Update System</span>
          </div>
        </div>

        <div class="nav-section">
          <h3>Account</h3>
          <div class="nav-item" onclick="logout()">
            <i class="codicon codicon-sign-out"></i>
            <span>Logout</span>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <div class="header">
          <div class="header-title" id="current-tab">Dashboard</div>
          <div class="header-actions">
            <div class="user-menu" onclick="logout()">
              <div class="user-avatar">DM</div>
              <div class="user-info">
                <div class="user-name">Admin User</div>
                <div class="user-role">Administrator</div>
              </div>
              <i class="codicon codicon-chevron-down"></i>
            </div>
          </div>
        </div>

        <!-- Content -->
        <div class="content">
          <!-- Dashboard Panel -->
          <div id="panel-dashboard">
            <div class="section">
              <div class="section-header">
                <h2 class="section-title">System Overview</h2>
                <div class="d-flex gap-2">
                  <span class="status-badge success">
                    <i class="codicon codicon-pass"></i> Operational
                  </span>
                </div>
              </div>

              <div class="card-grid">
                <div class="card">
                  <div class="card-header">
                    <div class="card-icon">
                      <i class="codicon codicon-server"></i>
                    </div>
                    <h3 class="card-title">Resources</h3>
                  </div>
                  <div class="card-body">
                    <div class="mb-2">
                      <small class="text-secondary">CPU Usage</small>
                      <div class="d-flex align-items-center">
                        <div class="progress w-100" style="height: 8px;">
                          <div class="progress-bar" role="progressbar" style="width: 45%;"></div>
                        </div>
                        <small class="ms-2">45%</small>
                      </div>
                    </div>
                    <div class="mb-2">
                      <small class="text-secondary">Memory</small>
                      <div class="d-flex align-items-center">
                        <div class="progress w-100" style="height: 8px;">
                          <div class="progress-bar bg-warning" role="progressbar" style="width: 68%;"></div>
                        </div>
                        <small class="ms-2">68%</small>
                      </div>
                    </div>
                    <div>
                      <small class="text-secondary">Disk</small>
                      <div class="d-flex align-items-center">
                        <div class="progress w-100" style="height: 8px;">
                          <div class="progress-bar bg-success" role="progressbar" style="width: 32%;"></div>
                        </div>
                        <small class="ms-2">32%</small>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer">
                    <button class="btn btn-outline btn-sm">
                      <i class="codicon codicon-eye"></i> Details
                    </button>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header">
                    <div class="card-icon">
                      <i class="codicon codicon-shield"></i>
                    </div>
                    <h3 class="card-title">Security Status</h3>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <div class="d-flex justify-content-between mb-1">
                        <span>Firewall</span>
                        <span class="status-badge success">Active</span>
                      </div>
                      <div class="d-flex justify-content-between mb-1">
                        <span>Intrusion Detection</span>
                        <span class="status-badge warning">Monitoring</span>
                      </div>
                      <div class="d-flex justify-content-between">
                        <span>Encryption</span>
                        <span class="status-badge success">Enabled</span>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer">
                    <button class="btn btn-outline btn-sm">
                      <i class="codicon codicon-shield"></i> Configure
                    </button>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header">
                    <div class="card-icon">
                      <i class="codicon codicon-history"></i>
                    </div>
                    <h3 class="card-title">Recent Activity</h3>
                  </div>
                  <div class="card-body">
                    <div class="mb-2">
                      <div class="d-flex justify-content-between">
                        <small>System updated</small>
                        <small class="text-secondary">2 min ago</small>
                      </div>
                    </div>
                    <div class="mb-2">
                      <div class="d-flex justify-content-between">
                        <small>Backup completed</small>
                        <small class="text-secondary">1 hour ago</small>
                      </div>
                    </div>
                    <div>
                      <div class="d-flex justify-content-between">
                        <small>User logged in</small>
                        <small class="text-secondary">3 hours ago</small>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer">
                    <button class="btn btn-outline btn-sm">
                      <i class="codicon codicon-notebook"></i> View Logs
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-header">
                <h2 class="section-title">Quick Actions</h2>
              </div>
              <div class="d-flex flex-wrap gap-3 mb-4">
                <button class="btn btn-success" onclick="apiAction('run')">
                  <i class="codicon codicon-play"></i> Start Services
                </button>
                <button class="btn btn-warning" onclick="apiAction('stop')">
                  <i class="codicon codicon-debug-stop"></i> Stop Services
                </button>
                <button class="btn btn-primary" onclick="apiAction('restart')">
                  <i class="codicon codicon-refresh"></i> Restart System
                </button>
                <button class="btn btn-info" onclick="apiAction('update')">
                  <i class="codicon codicon-cloud-download"></i> Update System
                </button>
              </div>
            </div>

            <div class="section">
              <div class="section-header">
                <h2 class="section-title">Scripts</h2>
                <button class="btn btn-outline btn-sm">
                  <i class="codicon codicon-add"></i> New Script
                </button>
              </div>
              <div id="scriptsList" class="d-flex flex-wrap gap-2"></div>
            </div>
          </div>

          <!-- Files Panel -->
          <div id="panel-files" style="display: none; height: 100%;">
            <div class="explorer-container">
              <div class="explorer-sidebar">
                <div class="d-flex align-items-center justify-content-between p-3">
                  <h3 class="mb-0">Explorer</h3>
                  <button class="btn btn-sm btn-outline">
                    <i class="codicon codicon-refresh"></i>
                  </button>
                </div>
                <ul class="file-tree"></ul>
              </div>
              <div class="explorer-content">
                <div class="editor-header">
                  <h3 class="editor-title">
                    <i class="codicon codicon-file-code"></i>
                    <span id="current-file">Select a file to edit</span>
                  </h3>
                  <div>
                    <button class="btn btn-primary btn-sm">
                      <i class="codicon codicon-save"></i> Save
                    </button>
                  </div>
                </div>
                <textarea class="form-control" id="fileEditorPanelText" rows="20" spellcheck="false"></textarea>
              </div>
            </div>
          </div>

          <!-- Terminal Panel -->
          <div id="panel-terminal" style="display: none;">
            <div class="section">
              <div class="section-header">
                <h2 class="section-title">System Terminal</h2>
                <button class="btn btn-outline btn-sm" onclick="clearTerminal()">
                  <i class="codicon codicon-clear-all"></i> Clear
                </button>
              </div>

              <div class="terminal-container">
                <div class="terminal-header">
                  <i class="codicon codicon-terminal"></i>
                  <span>System Console</span>
                </div>
                <div id="terminal" class="terminal">
                  <div class="terminal-line">[2023-11-15 09:32:15] System initialized</div>
                  <div class="terminal-line">[2023-11-15 09:32:18] Services started successfully</div>
                  <div class="terminal-line">[2023-11-15 09:33:45] User admin authenticated</div>
                  <div class="terminal-line">[2023-11-15 09:35:22] Security scan completed - no threats found</div>
                  <div class="terminal-line">[2023-11-15 09:40:10] Backup process initiated</div>
                </div>
              </div>

              <form class="d-flex gap-2 mt-2" onsubmit="sendTerminal(event)">
                <input id="terminalInput" class="form-control terminal-input" placeholder="Enter command..."
                  autocomplete="off" />
                <button class="btn btn-primary" type="submit">
                  <i class="codicon codicon-play"></i> Run
                </button>
                <button class="btn btn-outline" type="button" onclick="loadTerminal()">
                  <i class="codicon codicon-refresh"></i>
                </button>
              </form>
            </div>
          </div>

          <!-- Config Panel -->
          <div id="panel-config" style="display: none;">
            <div class="section">
              <div class="section-header">
                <h2 class="section-title">System Configuration</h2>
                <div>
                  <button class="btn btn-primary" onclick="saveConfig()">
                    <i class="codicon codicon-save"></i> Save Configuration
                  </button>
                </div>
              </div>

              <div class="mb-4">
                <div class="alert alert-secondary d-flex align-items-center">
                  <i class="codicon codicon-info me-2"></i>
                  Edit the system configuration file below. Changes take effect after saving.
                </div>
              </div>

              <textarea id="configEditor" class="form-control mb-3" rows="20" spellcheck="false">{
  "build": "echo No build step defined",
  "scripts": {
    "echo": "echo \"hello world!\""
  },
  "start": "python app.py"
}</textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
  </div>

  <!-- Status Bar (moved outside main-app for fixed positioning) -->
  <div class="status-bar" style="position:fixed;left:0;right:0;bottom:0;z-index:200;">
    <div class="d-flex gap-3">
      <span><i class="codicon codicon-circle-filled text-success"></i> Operational</span>
      <span>Dashboard v0.0.3</span>
    </div>
    <div class="ms-auto">
      <span>© 2025 Central Management System</span>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" style="position: fixed; top: 24px; right: 24px; z-index: 9999;"></div>

  <script>
    // API base URL
    const API = location.origin;
    let SECRET_KEY = localStorage.getItem('secretKey') || '';

    // --- Helper: Auth header ---
    function authHeaders() {
      return {
        'Authorization': 'Bearer ' + SECRET_KEY,
        'Content-Type': 'application/json',
      };
    }

    // --- Auth functions ---
    function login() {
      const key = document.getElementById('secretKey').value;
      if (!key) {
        document.getElementById('auth-error').style.display = 'block';
        return;
      }
      // Try a real API call to /config to check auth
      fetch(API + '/config', { headers: { 'Authorization': 'Bearer ' + key } })
        .then(r => {
          if (r.ok) {
            SECRET_KEY = key;
            localStorage.setItem('secretKey', key);
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('main-app').style.display = '';
            initApp();
          } else {
            document.getElementById('auth-error').style.display = 'block';
          }
        })
        .catch(() => {
          document.getElementById('auth-error').style.display = 'block';
        });
    }

    function logout() {
      SECRET_KEY = '';
      localStorage.removeItem('secretKey');
      document.getElementById('main-app').style.display = 'none';
      document.getElementById('auth-section').style.display = 'flex';
      document.getElementById('secretKey').value = '';
    }

    // --- Config functions ---
    function loadConfig() {
      fetch(API + '/config', { headers: authHeaders() })
        .then(r => r.json())
        .then(cfg => {
          document.getElementById('configEditor').value = JSON.stringify(cfg, null, 2);
          // Populate scripts
          let html = '';
          if (cfg.scripts) {
            for (const [name, cmd] of Object.entries(cfg.scripts)) {
              html += `<button class="btn btn-outline mb-2" onclick="runScript('${name}')">
                <i class='codicon codicon-run'></i> ${name}
              </button>`;
            }
          }
          document.getElementById('scriptsList').innerHTML = html;
        })
        .catch(() => {
          showToast('Failed to load config', 'error', 'Config Error');
        });
    }

    function saveConfig() {
      let val = document.getElementById('configEditor').value;
      let data;
      try {
        data = JSON.parse(val);
      } catch (e) {
        showToast('Invalid JSON: ' + e, 'error', 'Config Error');
        return;
      }
      fetch(API + '/config', {
        method: 'PUT',
        headers: authHeaders(),
        body: JSON.stringify(data)
      })
        .then(r => r.json())
        .then(res => {
          if (res.status === 'saved') {
            showToast('Configuration saved successfully', 'success', 'Config Saved');
            loadConfig();
          } else {
            showToast('Failed to save config', 'error', 'Config Error');
          }
        })
        .catch(() => showToast('Failed to save config', 'error', 'Config Error'));
    }

    // --- Terminal functions ---
    function loadTerminal() {
      fetch(API + '/terminal/logs', { headers: authHeaders() })
        .then(r => r.json())
        .then(data => {
          const terminal = document.getElementById('terminal');
          terminal.innerHTML = '';
          (data.logs || []).forEach(line => {
            terminal.innerHTML += `<div class='terminal-line'>${line}</div>`;
          });
          terminal.scrollTop = terminal.scrollHeight;
        })
        .catch(() => showToast('Failed to load terminal logs', 'error', 'Terminal'));
    }

    function clearTerminal() {
      fetch(API + '/terminal/exec', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ cmd: 'clear' })
      })
        .then(() => loadTerminal());
    }

    function sendTerminal(e) {
      e.preventDefault();
      const input = document.getElementById('terminalInput');
      const command = input.value.trim();
      input.value = '';
      if (!command) return;
      fetch(API + '/terminal/exec', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ cmd: command })
      })
        .then(() => loadTerminal());
    }

    // --- Scripts ---
    function runScript(name) {
      fetch(API + '/script/' + encodeURIComponent(name), {
        method: 'POST',
        headers: authHeaders()
      })
        .then(r => r.json())
        .then(res => {
          if (res.status === 'started') {
            showToast(`Running script: ${name}`, 'success', 'Script Execution');
            loadTerminal();
          } else {
            showToast(res.error || 'Failed to run script', 'error', 'Script Error');
          }
        })
        .catch(() => showToast('Failed to run script', 'error', 'Script Error'));
    }

    // --- System actions ---
    function apiAction(action) {
      let endpoint = '';
      if (action === 'run') endpoint = '/run';
      else if (action === 'stop') endpoint = '/stop';
      else if (action === 'restart') endpoint = '/restart';
      else if (action === 'update') endpoint = '/update';
      if (!endpoint) return;
      fetch(API + endpoint, {
        method: 'POST',
        headers: authHeaders()
      })
        .then(r => r.json())
        .then(res => {
          if (res.status) {
            showToast(res.status.charAt(0).toUpperCase() + res.status.slice(1), 'success', 'Action Completed');
            loadTerminal();
          } else {
            showToast(res.error || 'Action failed', 'error', 'Action Error');
          }
        })
        .catch(() => showToast('Action failed', 'error', 'Action Error'));
    }

    // --- File Explorer (basic) ---
    function loadFiles() {
      fetch(API + '/files', { headers: authHeaders() })
        .then(r => r.json())
        .then(data => {
          console.log('Files API response:', data); // Debug log
          // Build a nested tree from flat file paths
          function buildTree(paths) {
            const root = {};
            for (const path of paths) {
              const parts = path.split(/[\\\/]/); // handle both / and \
              let node = root;
              for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                if (!node[part]) {
                  node[part] = (i === parts.length - 1) ? null : {};
                }
                node = node[part] || {};
              }
            }
            return root;
          }

          // Recursively render the tree as HTML
          function renderTree(node, parentPath = '') {
            let html = '';
            for (const [name, child] of Object.entries(node)) {
              const fullPath = parentPath ? parentPath + '/' + name : name;
              if (child === null) {
                // File
                const icon = getFileIcon(name);
                html += `<li class="file" onclick="openFile('${fullPath.replace(/'/g, "\\'")}")">
                  <i class="${icon}"></i>
                  <span>${name}</span>
                </li>`;
              } else {
                // Folder
                html += `<li class="folder" onclick="toggleFolder(this)">
                  <i class="codicon codicon-folder"></i>
                  <span>${name}</span>
                </li>`;
                html += `<ul class="folder-children">${renderTree(child, fullPath)}</ul>`;
              }
            }
            return html;
          }

          // Helper to get icon class by file extension
          function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (ext === 'js') return 'codicon codicon-file-code';
            if (ext === 'json') return 'codicon codicon-settings-gear';
            if (ext === 'md') return 'codicon codicon-markdown';
            if (ext === 'py') return 'codicon codicon-file-code';
            if (ext === 'txt') return 'codicon codicon-file';
            return 'codicon codicon-file';
          }

          // Render the tree
          const files = Array.isArray(data.files) ? data.files.map(f => f.name) : [];
          const tree = buildTree(files);
          const html = renderTree(tree);
          document.querySelector('.explorer-sidebar .file-tree').innerHTML = html;
        })
        .catch(err => {
          console.error('Failed to load files:', err);
          document.querySelector('.explorer-sidebar .file-tree').innerHTML = '<li class="text-danger px-3">Failed to load files.</li>';
        });
    }

    // Initialize the app
    function initApp() {
      // Set current date in status bar
      const now = new Date();
      document.querySelector('.status-bar').innerHTML += `<span class="ms-3">${now.toLocaleDateString()} ${now.toLocaleTimeString()}</span>`;

      // Load initial data
      loadConfig();
      loadTerminal();

      // Simulate resource usage updates
      setInterval(() => {
        const cpu = Math.floor(Math.random() * 30) + 30;
        const memory = Math.floor(Math.random() * 20) + 60;
        document.querySelector('.progress-bar').style.width = `${cpu}%`;
        document.querySelector('.progress-bar').nextElementSibling.textContent = `${cpu}%`;
        document.querySelector('.progress-bar.bg-warning').style.width = `${memory}%`;
        document.querySelector('.progress-bar.bg-warning').nextElementSibling.textContent = `${memory}%`;
      }, 5000);
    }

    // Tab switching
    function switchTab(tab) {
      // Hide all panels
      document.querySelectorAll('.content > div').forEach(panel => {
        panel.style.display = 'none';
      });

      // Show selected panel
      document.getElementById(`panel-${tab}`).style.display = '';

      // Update current tab title
      const tabNames = {
        'dashboard': 'Dashboard',
        'files': 'File Explorer',
        'terminal': 'System Terminal',
        'config': 'Configuration'
      };
      document.getElementById('current-tab').textContent = tabNames[tab];

      // Update active nav item
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });

      // Activate the correct nav item
      let navItem;
      if (tab === 'dashboard') {
        navItem = document.querySelector('.nav-item:nth-child(1)');
      } else if (tab === 'files') {
        navItem = document.querySelector('.nav-item:nth-child(2)');
      } else if (tab === 'terminal') {
        navItem = document.querySelector('.nav-item:nth-child(3)');
      } else if (tab === 'config') {
        navItem = document.querySelector('.nav-item:nth-child(4)');
      }

      if (navItem) navItem.classList.add('active');

      // Load files when switching to the files tab
      if (tab === 'files') {
        loadFiles();
      }
    }

    // Toast notifications
    function showToast(message, type = 'info', title = 'Notification') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-icon">
          <i class="codicon codicon-${type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info'}"></i>
        </div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close">
          <i class="codicon codicon-close"></i>
        </button>
      `;

      document.getElementById('toast-container').appendChild(toast);
      toast.classList.add('show');

      // Close button
      toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      });

      // Auto remove after 5 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // Folder toggle
    function toggleFolder(element) {
      element.classList.toggle('open');
      const children = element.nextElementSibling;
      if (children) {
        children.style.display = children.style.display === 'none' ? 'block' : 'none';
      }
    }

    // File open
    function openFile(filename) {
      document.getElementById('current-file').textContent = filename;
      document.getElementById('fileEditorPanelText').value = `// Contents of ${filename}\n\nfunction example() {\n  console.log("Hello, world!");\n}\n`;
    }

    // Terminal functions
    function loadTerminal() {
      fetch(API + '/terminal/logs', { headers: authHeaders() })
        .then(r => r.json())
        .then(data => {
          const terminal = document.getElementById('terminal');
          terminal.innerHTML = '';
          (data.logs || []).forEach(line => {
            terminal.innerHTML += `<div class='terminal-line'>${line}</div>`;
          });
          terminal.scrollTop = terminal.scrollHeight;
        })
        .catch(() => showToast('Failed to load terminal logs', 'error', 'Terminal'));
    }

    function clearTerminal() {
      fetch(API + '/terminal/exec', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ cmd: 'clear' })
      })
        .then(() => loadTerminal());
    }

    function sendTerminal(e) {
      e.preventDefault();
      const input = document.getElementById('terminalInput');
      const command = input.value.trim();
      input.value = '';
      if (!command) return;
      fetch(API + '/terminal/exec', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ cmd: command })
      })
        .then(() => loadTerminal());
    }

    // Config functions
    function loadConfig() {
      fetch(API + '/config', { headers: authHeaders() })
        .then(r => r.json())
        .then(cfg => {
          document.getElementById('configEditor').value = JSON.stringify(cfg, null, 2);
          // Populate scripts
          let html = '';
          if (cfg.scripts) {
            for (const [name, cmd] of Object.entries(cfg.scripts)) {
              html += `<button class="btn btn-outline mb-2" onclick="runScript('${name}')">
                <i class='codicon codicon-run'></i> ${name}
              </button>`;
            }
          }
          document.getElementById('scriptsList').innerHTML = html;
        })
        .catch(() => {
          showToast('Failed to load config', 'error', 'Config Error');
        });
    }

    function saveConfig() {
      let val = document.getElementById('configEditor').value;
      let data;
      try {
        data = JSON.parse(val);
      } catch (e) {
        showToast('Invalid JSON: ' + e, 'error', 'Config Error');
        return;
      }
      fetch(API + '/config', {
        method: 'PUT',
        headers: authHeaders(),
        body: JSON.stringify(data)
      })
        .then(r => r.json())
        .then(res => {
          if (res.status === 'saved') {
            showToast('Configuration saved successfully', 'success', 'Config Saved');
            loadConfig();
          } else {
            showToast('Failed to save config', 'error', 'Config Error');
          }
        })
        .catch(() => showToast('Failed to save config', 'error', 'Config Error'));
    }

    // Initialize the app if we're bypassing auth for demo
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('secretKey')) {
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('main-app').style.display = '';
        SECRET_KEY = localStorage.getItem('secretKey');
        initApp();
      } else {
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('auth-section').style.display = 'flex';
      }
    });
  </script>
</body>

</html>