<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Central Management Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/@vscode/codicons/dist/codicon.css" rel="stylesheet"/>
  <style>
    body {
      background: #181a1b;
      color: #e0e0e0;
      font-family: 'Segoe UI', 'Liberation Sans', Arial, sans-serif;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden; /* Prevent unwanted scrollbars */
    }
    .vscode-activitybar {
      width: 56px;
      background: #23232b;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 44px;
      border-right: 1px solid #222;
      z-index: 21;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      box-sizing: border-box;
      box-shadow: 2px 0 8px #0002;
    }
    .vscode-activitybar .codicon {
      font-size: 24px;
      color: #bdbdbd;
      margin: 0 0 16px 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: background 0.15s, color 0.2s;
      cursor: pointer;
    }
    .vscode-activitybar .codicon.active, .vscode-activitybar .codicon:hover {
      color: #fff;
      background: #3794ff;
    }
    .vscode-titlebar {
      height: 48px;
      background: #23232b;
      display: flex;
      align-items: center;
      padding: 0 24px;
      border-bottom: 1px solid #222;
      font-size: 18px;
      color: #fff;
      letter-spacing: 0.5px;
      position: fixed;
      top: 0;
      left: 56px;
      right: 0;
      width: auto; /* Use auto, not 100vw */
      z-index: 22;
      box-shadow: 0 2px 8px #0002;
    }
    .vscode-shell {
      display: flex;
      flex-direction: row;
      height: calc(100% - 48px); /* Use 100% instead of 100vh */
      width: 100%; /* Use 100% instead of 100vw */
      margin-left: 56px; /* offset for activity bar */
      margin-top: 48px;
      background: #181a1b;
      overflow: hidden; /* Prevent scrollbars */
    }
    @media (max-width: 700px) {
      .vscode-shell {
        flex-direction: column;
        margin-left: 0; /* remove offset on mobile */
        margin-top: 48px;
        width: 100%;
        height: calc(100% - 48px);
        overflow: hidden;
      }
      .vscode-activitybar {
        flex-direction: row;
        width: 100vw;
        height: 48px;
        left: 0;
        top: 0;
        padding-top: 0;
        border-right: none;
        border-bottom: 1px solid #222;
        box-shadow: 0 2px 8px #0002;
      }
      .vscode-titlebar {
        left: 0;
        top: 48px;
        right: 0;
        width: auto;
      }
      .vscode-explorer {
        display: none !important;
      }
      .vscode-panel {
        padding: 8px 0 6px 0;
      }
      #fileEditorPanelName {
        white-space: normal;
      }
      #fileEditorModal .modal-header {
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
      }
      #fileEditorName {
        white-space: normal;
      }
    }
    .vscode-explorer {
      background: #23232b;
      color: #d4d4d4;
      width: 240px;
      min-width: 160px;
      max-width: 320px;
      border-right: 1px solid #222;
      padding: 16px 0 0 0;
      height: 100%;
      overflow-y: auto;
      font-size: 15px;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 8px #0001;
    }
    .vscode-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #181a1b;
      min-width: 0;
    }
    .vscode-content {
      flex: 1;
      overflow: auto;
      padding: 0;
      background: #181a1b;
      display: flex;
      flex-direction: column;
    }
    .vscode-panel {
      background: #23232b;
      color: #e0e0e0;
      padding: 32px 32px 24px 32px;
      flex: 1;
      overflow-y: auto;
      min-width: 0;
      border-radius: 0;
      margin: 0;
      max-width: none;
      box-shadow: none;
    }
    .vscode-panel h3 {
      color: #fff;
      font-size: 1.3rem;
      margin-top: 0;
      margin-bottom: 1.2rem;
      font-weight: 600;
    }
    .vscode-panel label, .vscode-panel .form-label {
      color: #e0e0e0;
    }
    .vscode-panel .form-control, .vscode-panel textarea {
      background: #23232b;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 1rem;
    }
    .vscode-panel .btn {
      background: #23232b;
      color: #e0e0e0;
      border: 1px solid #333;
      margin-right: 8px;
      border-radius: 6px;
      font-size: 1rem;
      padding: 8px 20px;
      transition: background 0.2s, color 0.2s;
    }
    .vscode-panel .btn-primary, .vscode-panel .btn-success, .vscode-panel .btn-warning, .vscode-panel .btn-info, .vscode-panel .btn-danger {
      color: #fff;
      border: none;
    }
    .vscode-panel .btn-primary { background: #3794ff; }
    .vscode-panel .btn-success { background: #388a34; }
    .vscode-panel .btn-warning { background: #b89500; }
    .vscode-panel .btn-info { background: #007acc; }
    .vscode-panel .btn-danger { background: #c74e39; }
    .vscode-panel .btn-outline-secondary { color: #e0e0e0; border: 1px solid #555; background: none; }
    .vscode-panel .list-group-item {
      background: #23232b;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 6px;
      margin-bottom: 6px;
    }
    .vscode-terminal {
      background: #181a1b;
      color: #e0e0e0;
      font-family: 'Fira Mono', 'Consolas', 'monospace';
      padding: 16px;
      height: 220px;
      overflow: auto;
      border-radius: 6px;
      border: 1px solid #23232b;
      margin-bottom: 8px;
      white-space: pre;
      font-size: 1rem;
    }
    .vscode-terminal-input {
      background: #23232b;
      color: #e0e0e0;
      border: 1px solid #333;
      font-family: 'Fira Mono', 'Consolas', 'monospace';
      padding: 8px 12px;
      border-radius: 6px;
      width: 100%;
      margin-right: 8px;
      font-size: 1rem;
    }
    .vscode-panel .btn-close {
      filter: invert(1);
    }
    .vscode-panel .toast {
      min-width: 220px;
    }
    .vscode-panel .form-control:focus, .vscode-panel textarea:focus, .vscode-terminal-input:focus {
      border-color: #3794ff;
      outline: none;
      box-shadow: 0 0 0 1px #3794ff;
    }
    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .vscode-panel {
        padding: 24px 2vw 16px 2vw;
      }
    }
    @media (max-width: 900px) {
      .vscode-panel {
        padding: 14px 1vw 10px 1vw;
      }
      .vscode-explorer {
        width: 120px;
        min-width: 80px;
        font-size: 13px;
      }
      .vscode-titlebar {
        font-size: 15px;
        padding: 0 8px;
      }
    }
    @media (max-width: 700px) {
      .vscode-shell {
        flex-direction: column;
        margin-left: 0;
        margin-top: 48px;
        width: 100%;
        height: calc(100% - 48px);
        overflow: hidden;
      }
      .vscode-activitybar {
        flex-direction: row;
        width: 100vw;
        height: 48px;
        left: 0;
        top: 0;
        padding-top: 0;
        border-right: none;
        border-bottom: 1px solid #222;
        box-shadow: 0 2px 8px #0002;
      }
      .vscode-titlebar {
        left: 0;
        top: 48px;
        right: 0;
        width: auto;
      }
      .vscode-explorer {
        display: none !important;
      }
      .vscode-panel {
        padding: 8px 0 6px 0;
      }
      #fileEditorPanelName, #fileEditorName {
        white-space: normal;
        text-overflow: initial;
        overflow: visible;
      }
      #fileEditorPanel > div[style*='display:flex'],
      #fileEditorModal .modal-header {
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
        width: 100%;
      }
      #fileEditorPanelSave, #fileEditorModal .btn-close {
        align-self: flex-end;
        margin-left: 0;
      }
      #fileEditorPanelName, #fileEditorName {
        white-space: normal;
      }
    }
    .vscode-statusbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      width: auto;
      height: 32px;
      background: #23232b;
      color: #bdbdbd;
      display: flex;
      align-items: center;
      padding-left: 64px;
      font-size: 14px;
      z-index: 30;
      box-shadow: 0 -2px 8px #0002;
    }
    @media (max-width: 700px) {
      .vscode-statusbar { padding-left: 16px; left: 0; right: 0; width: auto; }
    }
    /* File editor modal */
    #fileEditorContainer {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(24,26,27,0.96);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #fileEditorModal {
      background: #23232b;
      border-radius: 12px;
      box-shadow: 0 8px 32px #0006;
      padding: 32px 24px 24px 24px;
      max-width: 90vw;
      width: 480px;
      margin: auto;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #fileEditorModal textarea {
      min-height: 200px;
      font-size: 1rem;
      border-radius: 6px;
      background: #181a1b;
      color: #e0e0e0;
      border: 1px solid #333;
      padding: 12px;
    }
    #fileEditorModal .modal-header {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      min-width: 0;
      width: 100%;
      justify-content: flex-start !important;
    }
    #fileEditorName {
      flex: 1 1 0%;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      word-break: break-all;
      font-weight: 600;
    }
    /* Toasts on top right */
    .toast {
      top: 16px !important;
      right: 16px !important;
      left: auto !important;
      z-index: 99999 !important;
    }
  </style>
</head>
<body>
  <div class="vscode-activitybar">
    <span class="codicon codicon-home active" title="Dashboard" onclick="switchTab('dashboard')"></span>
    <span class="codicon codicon-files" title="Explorer" onclick="switchTab('files')"></span>
    <span class="codicon codicon-terminal" title="Terminal" onclick="switchTab('terminal')"></span>
    <span class="codicon codicon-settings-gear" title="Config" onclick="switchTab('config')"></span>
    <span class="codicon codicon-sign-out" title="Logout" onclick="logout()"></span>
  </div>
  <div class="vscode-titlebar"><span class="codicon codicon-rocket"></span>&nbsp;Central Management Dashboard</div>
  <div class="vscode-shell">
    <div class="vscode-explorer" id="explorer-panel" style="display:none;">
      <div class="explorer-title">EXPLORER</div>
      <ul id="explorerFileTree"></ul>
    </div>
    <div class="vscode-main">
      <div class="vscode-content">
        <div class="vscode-panel" id="panel-dashboard">
          <h3>Quick Actions</h3>
          <div class="d-flex flex-wrap gap-2 mb-3">
            <button class="btn btn-success" onclick="apiAction('run')" data-label="Run"><span class="codicon codicon-play"></span> Run</button>
            <button class="btn btn-warning" onclick="apiAction('stop')" data-label="Stop"><span class="codicon codicon-debug-stop"></span> Stop</button>
            <button class="btn btn-info" onclick="apiAction('restart')" data-label="Restart"><span class="codicon codicon-refresh"></span> Restart</button>
            <button class="btn btn-secondary" onclick="apiAction('update')" data-label="Update"><span class="codicon codicon-cloud-download"></span> Update</button>
          </div>
          <div id="status" class="mt-3"></div>
          <h3 class="mt-4">Scripts</h3>
          <div id="scriptsList" class="d-flex flex-wrap gap-2"></div>
        </div>
        <div class="vscode-panel" id="panel-config" style="display:none;">
          <h3>Edit config.json</h3>
          <textarea id="configEditor" class="form-control mb-2" rows="10" spellcheck="false"></textarea>
          <button class="btn btn-primary btn-sm mb-3" onclick="saveConfig()" data-label="Save Config">Save Config</button>
        </div>
        <div class="vscode-panel d-flex flex-row" id="panel-files" style="display:none; min-height:400px; overflow:hidden;">
          <ul id="explorerFileTree" style="background:#23232b; border-right:1px solid #222; margin:0; padding:16px 0 0 0; height:100%; overflow-y:auto; overflow-x:hidden; resize:none; transition:width 0.1s; list-style:none;"></ul>
          <div id="explorerResizer" style="width:6px; cursor:col-resize; background:#23232b; z-index:10; position:relative;"></div>
          <div id="fileEditorPanel" style="display:none; flex:1 1 0%; margin:24px 0 0 32px; min-width:0; overflow:auto; max-width:100vw;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
              <span id="fileEditorPanelName" style="font-weight:600; word-break:break-all; flex:1;"></span>
              <button id="fileEditorPanelSave" class="btn btn-primary btn-sm" title="Save File" onclick="saveFilePanelEdit()" style="flex-shrink:0;"><span class="codicon codicon-save"></span></button>
            </div>
            <textarea id="fileEditorPanelText" class="form-control mb-2" rows="20" spellcheck="false" style="margin-top:8px; min-height:320px; background:#181a1b; color:#e0e0e0; border:1px solid #333; width:100%; resize:vertical; overflow-x:auto; overflow-y:auto;"></textarea>
          </div>
        </div>
        <div class="vscode-panel" id="panel-terminal" style="display:none;">
          <div id="terminal" class="vscode-terminal">Loading...</div>
          <form class="d-flex mt-2" onsubmit="sendTerminal(event)">
            <input id="terminalInput" class="vscode-terminal-input" placeholder="Enter command" autocomplete="off" />
            <button class="btn btn-dark" type="submit" data-label="Run">Run</button>
            <button class="btn btn-outline-secondary ms-2" type="button" onclick="loadTerminal()">Refresh</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div class="vscode-statusbar">
    <span id="statusbar-text">Dashboard &copy; Dusan Mitrovic 2025</span>
  </div>
  <div id="fileEditorContainer">
    <div id="fileEditorModal">
      <div class="modal-header">
        <span id="fileEditorName" style="font-weight:600;"></span>
        <button class="btn-close" onclick="closeFileEditor()"></button>
      </div>
      <textarea id="fileEditor" class="form-control mb-2" rows="12" spellcheck="false"></textarea>
      <button class="btn btn-primary btn-sm mb-2" onclick="saveFileEdit()" data-label="Save File">Save File</button>
    </div>
  </div>
  <div id="auth-section" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#181a1b;z-index:10000;display:flex;align-items:center;justify-content:center;">
    <form onsubmit="login(); return false;" class="card p-4 shadow" style="min-width:320px;background:#23232b;border-radius:12px;box-shadow:0 4px 24px #0006;">
      <div class="mb-2" style="color:#fff;font-size:1.2rem;text-align:center;">Login</div>
      <input type="password" id="secretKey" class="form-control mb-2" placeholder="Enter Secret Key"/>
      <button class="btn btn-primary w-100" type="submit">Login</button>
      <div id="auth-error" class="text-danger mt-2 hidden">Invalid key. Try again.</div>
    </form>
  </div>
  <script>
    const API = location.origin;
    function switchTab(tab) {
      // Tabs
      ['dashboard','config','files','terminal'].forEach(t => {
        document.getElementById('panel-' + t).style.display = (t === tab) ? '' : 'none';
      });
      // Sidebar
      document.querySelectorAll('.vscode-sidebar .codicon, .vscode-activitybar .codicon').forEach((el, i) => {
        el.classList.toggle('active',
          (tab === 'dashboard' && (el.title === 'Dashboard' || el.title === 'Home')) ||
          (tab === 'config' && el.title === 'Config') ||
          (tab === 'files' && (el.title === 'Files' || el.title === 'Explorer')) ||
          (tab === 'terminal' && el.title === 'Terminal')
        );
      });
      // Explorer panel
      document.getElementById('explorer-panel').style.display = (tab === 'files') ? '' : 'none';
    }

    // --- Explorer File Tree ---
    let openFolders = new Set(); // Track open folder paths
    function buildFileTree(files) {
      // Filter out .git and its children (including Windows backslash paths)
      files = files.filter(f => !f.name.replace(/\\/g, '/').startsWith('.git/') && !f.name.replace(/\\/g, '/').startsWith('.git\\') && f.name !== '.git');
      // Convert flat file list to tree structure
      let root = {};
      files.forEach(f => {
        let parts = f.name.split('/');
        let node = root;
        for (let i = 0; i < parts.length; i++) {
          let part = parts[i];
          if (!node[part]) node[part] = (i === parts.length - 1) ? {__file: true, name: f.name, size: f.size} : {};
          node = node[part];
        }
      });
      function render(node, path = '') {
        let html = '';
        // Folders first, then files (VS Code style)
        let folders = [];
        let files = [];
        for (let key in node) {
          if (key === '__file' || key === 'name' || key === 'size') continue;
          if (node[key].__file) files.push({ key, child: node[key] });
          else folders.push({ key, child: node[key] });
        }
        // Render folders
        folders.sort((a, b) => a.key.localeCompare(b.key)).forEach(({key, child}) => {
          let fullPath = path ? path + '/' + key : key;
          let isOpen = openFolders.has(fullPath);
          html += `<li class="folder${isOpen ? ' open' : ''}"><div class="folder-label" onclick="toggleFolder(this, '${fullPath}')"><span class="codicon codicon-folder"></span><span class="codicon codicon-folder-opened"></span>${key}</div>`;
          html += `<ul class="folder-children">${isOpen ? render(child, fullPath) : ''}</ul>`;
          html += `</li>`;
        });
        // Render files
        files.sort((a, b) => a.key.localeCompare(b.key)).forEach(({key, child}) => {
          html += `<li class="file" onclick='openFileEditorPanel("${child.name}")'><span class="codicon codicon-file"></span>${key}</li>`;
        });
        return html;
      }
      return render(root);
    }
    function toggleFolder(el, fullPath) {
      if (openFolders.has(fullPath)) {
        openFolders.delete(fullPath);
      } else {
        openFolders.add(fullPath);
      }
      loadExplorerFileTree(); // Re-render tree
    }
    function loadExplorerFileTree() {
      fetch(API + '/files', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        document.getElementById('explorerFileTree').innerHTML = buildFileTree(data.files||[]);
      })
      .catch(function() { showToast('Failed to load file tree', 'danger'); });
    }
    // Call this when switching to files tab
    const origSwitchTab = switchTab;
    switchTab = function(tab) {
      origSwitchTab(tab);
      if(tab === 'files') loadExplorerFileTree();
    }
    function showMainUI() {
      document.getElementById('auth-section').style.display = 'none';
      document.querySelector('.vscode-shell').style.display = 'flex';
    }
    function hideMainUI() {
      document.getElementById('auth-section').style.display = 'flex';
      document.querySelector('.vscode-shell').style.display = 'none';
    }
    function login() {
      const key = document.getElementById('secretKey').value;
      localStorage.setItem('secretKey', key);
      checkAuth();
    }
    function logout() {
      localStorage.removeItem('secretKey');
      hideMainUI();
    }
    function checkAuth() {
      fetch(API + '/run', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      }).then (r => {
        if (r.status === 401 || r.status === 403) throw new Error();
        showMainUI();
        document.getElementById('auth-error').classList.add('hidden');
        loadConfig();
      }).catch(() => {
        document.getElementById('auth-error').classList.remove('hidden');
      });
    }
    // --- Utility Functions ---
    function showToast(message, type = 'info') {
      let toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0 show position-fixed top-0 end-0 m-3`;
      toast.style.zIndex = 9999;
      toast.innerHTML = `<div class='d-flex'><div class='toast-body'>${message}</div><button type='button' class='btn-close btn-close-white me-2 m-auto' data-bs-dismiss='toast'></button></div>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
      toast.querySelector('.btn-close').onclick = () => toast.remove();
    }
    function setLoading(el, loading) {
      if (loading) {
        el.disabled = true;
        el.innerHTML = `<span class='spinner-border spinner-border-sm'></span>`;
      } else {
        el.disabled = false;
        el.innerHTML = el.dataset.label;
      }
    }
    // --- Terminal Improvements ---
    let terminalHistory = [];
    let terminalHistoryIndex = -1;
    function loadTerminal() {
      fetch(API + '/terminal/logs', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(r => r.json())
      .then(data => {
        const logs = (data.logs||[]).join('\n');
        const termDiv = document.getElementById('terminal');
        termDiv.innerText = logs;
        termDiv.scrollTop = termDiv.scrollHeight;
      })
      .catch(() => showToast('Failed to load terminal logs', 'danger'));
    }
    function sendTerminal(e) {
      e.preventDefault();
      let input = document.getElementById('terminalInput');
      let cmd = input.value.trim();
      input.value = '';
      if (!cmd) return;
      if (cmd === 'cls' || cmd === 'clear') {
        document.getElementById('terminal').innerText = '';
        terminalHistory.push(cmd);
        terminalHistoryIndex = terminalHistory.length;
        return;
      }
      terminalHistory.push(cmd);
      terminalHistoryIndex = terminalHistory.length;
      let runBtn = e.submitter;
      if (runBtn) setLoading(runBtn, true);
      fetch(API + '/terminal/exec', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('secretKey'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({cmd: cmd})
      })
      .then(() => loadTerminal())
      .catch(() => showToast('Terminal command failed', 'danger'))
      .finally(() => { if (runBtn) setLoading(runBtn, false); });
    }
    document.getElementById('terminalInput').addEventListener('keydown', function(e) {
      if (e.key === 'ArrowUp') {
        if (terminalHistoryIndex > 0) {
          terminalHistoryIndex--;
          this.value = terminalHistory[terminalHistoryIndex] || '';
        }
        e.preventDefault();
      } else if (e.key === 'ArrowDown') {
        if (terminalHistoryIndex < terminalHistory.length - 1) {
          terminalHistoryIndex++;
          this.value = terminalHistory[terminalHistoryIndex] || '';
        } else {
          terminalHistoryIndex = terminalHistory.length;
          this.value = '';
        }
        e.preventDefault();
      }
    });
    // --- Config Editor Improvements ---
    function saveConfig() {
      let btn = event.target;
      setLoading(btn, true);
      let val = document.getElementById('configEditor').value;
      try {
        JSON.parse(val);
      } catch {
        showToast('Invalid JSON in config', 'danger');
        setLoading(btn, false);
        return;
      }
      fetch(API + '/config', {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('secretKey'),
          'Content-Type': 'application/json'
        },
        body: val
      })
      .then(() => { showToast('Config saved', 'success'); loadConfig(); })
      .catch(() => showToast('Failed to save config', 'danger'))
      .finally(() => setLoading(btn, false));
    }
    // --- File Manager Improvements ---
    function uploadFile(e) {
      e.preventDefault();
      let file = document.getElementById('fileInput').files[0];
      if (!file) return showToast('No file selected', 'warning');
      let btn = e.submitter;
      setLoading(btn, true);
      fetch(API + '/files/' + encodeURIComponent(file.name), {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') },
        body: file
      })
      .then(() => { showToast('File uploaded', 'success'); loadFiles(); })
      .catch(() => showToast('File upload failed', 'danger'))
      .finally(() => setLoading(btn, false));
    }
    function deleteFile(name) {
      if (!confirm('Delete file ' + name + '?')) return;
      fetch(API + '/files/' + encodeURIComponent(name), {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(() => { showToast('File deleted', 'success'); loadFiles(); })
      .catch(() => showToast('File delete failed', 'danger'));
    }
    function loadFiles() {
      fetch(API + '/files', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(r => r.json())
      .then(data => {
        let html = '<ul class="list-group">';
        (data.files||[]).forEach(f => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">
            <span style='cursor:pointer' onclick='openFileEditor("${f.name}")'>${f.name} <small class='text-muted'>(${f.size} bytes)</small></span>
            <span>
              <button class='btn btn-sm btn-outline-success me-1' onclick='downloadFile("${f.name}")'>Download</button>
              <button class='btn btn-sm btn-outline-danger' onclick='deleteFile("${f.name}")'>Delete</button>
            </span>
          </li>`;
        });
        html += '</ul>';
        document.getElementById('fileList').innerHTML = html;
      });
    }
    function openFileEditor(name) {
      // Prevent opening .git or any hidden file
      if (name.startsWith('.git/') || name.startsWith('.git\\') || name === '.git') return;
      fetch(API + '/files/' + encodeURIComponent(name), {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(r => {
        if (!r.ok) throw new Error();
        return r.text();
      })
      .then(text => {
        document.getElementById('fileEditorName').innerText = name;
        document.getElementById('fileEditor').value = text;
        document.getElementById('fileEditorContainer').style.display = '';
      })
      .catch(() => showToast('Failed to load file', 'danger'));
    }
    function openFileEditorPanel(name) {
      // Prevent opening .git or any hidden file
      if (name.startsWith('.git/') || name.startsWith('.git\\') || name === '.git') return;
      fetch(API + '/files/' + encodeURIComponent(name), {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(r => {
        if (!r.ok) throw new Error();
        return r.text();
      })
      .then(text => {
        document.getElementById('fileEditorPanelName').innerText = name;
        document.getElementById('fileEditorPanelText').value = text;
        document.getElementById('fileEditorPanel').style.display = '';
      })
      .catch(() => showToast('Failed to load file', 'danger'));
    }
    function saveFileEdit() {
      let name = document.getElementById('fileEditorName').innerText;
      let content = document.getElementById('fileEditor').value;
      let btn = event.target;
      setLoading(btn, true);
      fetch(API + '/files/' + encodeURIComponent(name), {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') },
        body: content
      })
      .then(() => { showToast('File saved', 'success'); closeFileEditor(); loadFiles(); })
      .catch(() => showToast('Failed to save file', 'danger'))
      .finally(() => setLoading(btn, false));
    }
    function saveFilePanelEdit() {
      let name = document.getElementById('fileEditorPanelName').innerText;
      let content = document.getElementById('fileEditorPanelText').value;
      let btn = document.getElementById('fileEditorPanelSave');
      setLoading(btn, true);
      fetch(API + '/files/' + encodeURIComponent(name), {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') },
        body: content
      })
      .then(() => { showToast('File saved', 'success'); })
      .catch(() => showToast('Failed to save file', 'danger'))
      .finally(() => setLoading(btn, false));
    }
    function closeFileEditor() {
      document.getElementById('fileEditorContainer').style.display = 'none';
      document.getElementById('fileEditorName').innerText = '';
      document.getElementById('fileEditor').value = '';
    }
    // --- API Action Feedback ---
    function apiAction(action) {
      let btn = event.target;
      setLoading(btn, true);
      fetch(API + '/' + action, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(r => r.json())
      .then(function(data) {
        document.getElementById('status').innerText = JSON.stringify(data);
        showToast(action.charAt(0).toUpperCase() + action.slice(1) + ' complete', 'success');
      })
      .catch(function() {
        document.getElementById('status').innerText = 'Error!';
        showToast(action.charAt(0).toUpperCase() + action.slice(1) + ' failed', 'danger');
      })
      .finally(() => setLoading(btn, false));
    }
    function loadFiles() {
      fetch(API + '/files', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(r => r.json())
      .then(data => {
        let html = '<ul class="list-group">';
        (data.files||[]).forEach(f => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">
            <span style='cursor:pointer' onclick='openFileEditor("${f.name}")'>${f.name} <small class='text-muted'>(${f.size} bytes)</small></span>
            <span>
              <button class='btn btn-sm btn-outline-success me-1' onclick='downloadFile("${f.name}")'>Download</button>
              <button class='btn btn-sm btn-outline-danger' onclick='deleteFile("${f.name}")'>Delete</button>
            </span>
          </li>`;
        });
        html += '</ul>';
        document.getElementById('fileList').innerHTML = html;
      });
    }
    function uploadFile(e) {
      e.preventDefault();
      let file = document.getElementById('fileInput').files[0];
      if (!file) return showToast('No file selected', 'warning');
      let btn = e.submitter;
      setLoading(btn, true);
      fetch(API + '/files/' + encodeURIComponent(file.name), {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') },
        body: file
      })
      .then(() => { showToast('File uploaded', 'success'); loadFiles(); })
      .catch(() => showToast('File upload failed', 'danger'))
      .finally(() => setLoading(btn, false));
    }
    function downloadFile(name) {
      fetch(API + '/files/' + encodeURIComponent(name), {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(r => r.blob())
      .then(blob => {
        let url = window.URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;
        a.download = name.split('/').pop();
        document.body.appendChild(a);
        a.click();
        a.remove();
      });
    }
    function deleteFile(name) {
      if (!confirm('Delete file ' + name + '?')) return;
      fetch(API + '/files/' + encodeURIComponent(name), {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(() => { showToast('File deleted', 'success'); loadFiles(); })
      .catch(() => showToast('File delete failed', 'danger'));
    }
    function loadConfig() {
      fetch(API + '/config', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(r => r.json())
      .then(cfg => {
        document.getElementById('configEditor').value = JSON.stringify(cfg, null, 2);
        // --- Script Button Population: include top-level string keys as scripts ---
        let scripts = Object.assign({}, cfg.scripts || {});
        for (let key in cfg) {
          if (typeof cfg[key] === 'string' && !['scripts'].includes(key)) {
            scripts[key] = cfg[key];
          }
        }
        let html = '';
        for (let name in scripts) {
          html += `<button class="btn btn-outline-dark btn-sm me-2 mb-2" onclick="runScript('${name}')">${name}</button>`;
        }
        document.getElementById('scriptsList').innerHTML = html;
      });
      loadFiles();
    }
    function saveConfig() {
      let btn = event.target;
      setLoading(btn, true);
      let val = document.getElementById('configEditor').value;
      try {
        JSON.parse(val);
      } catch {
        showToast('Invalid JSON in config', 'danger');
        setLoading(btn, false);
        return;
      }
      fetch(API + '/config', {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('secretKey'),
          'Content-Type': 'application/json'
        },
        body: val
      })
      .then(() => { showToast('Config saved', 'success'); loadConfig(); })
      .catch(() => showToast('Failed to save config', 'danger'))
      .finally(() => setLoading(btn, false));
    }
    function runScript(name) {
      fetch(API + '/script/' + name, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('secretKey') }
      })
      .then(r => r.json())
      .then(data => alert('Script output: ' + JSON.stringify(data)));
    }
    if (localStorage.getItem('secretKey')) checkAuth();
    else hideMainUI();
    // --- Explorer Resizer ---
    (function() {
      let explorer = document.getElementById('explorerFileTree');
      let resizer = document.getElementById('explorerResizer');
      let panel = document.getElementById('panel-files');
      let dragging = false;
      let startX, startWidth;
      resizer.onmousedown = function(e) {
        dragging = true;
        startX = e.clientX;
        startWidth = explorer.offsetWidth;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
      };
      window.addEventListener('mousemove', function(e) {
        if (!dragging) return;
        let dx = e.clientX - startX;
        let newWidth = Math.max(120, Math.min(400, startWidth + dx));
        explorer.style.width = newWidth + 'px';
      });
      window.addEventListener('mouseup', function() {
        if (dragging) {
          dragging = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    })();
  </script>
</body>
</html>
